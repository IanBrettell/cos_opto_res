---
title: "COSMIKK behaviour notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Setup

# Test data

Raw videos uploaded here: `/nfs/ftp/private/indigene_ftp/upload/OMR_Risa/`

Test video here on local: `~/Documents/Data/20210104_cos_videos/recorded_with_iphone.avi`

Tried segmenting using `idtrackerai`, but it couldn't distinguish the fish against the background.
As there are no crossovers, try `ilastik` intead.

## Convert AVI to H5 for Ilastik

```{r, engine='bash'}
python3 code/scripts/20210106_avi2h5_fynn.py \
  ~/Documents/Data/20210104_cos_videos/recorded_with_iphone.avi \
  ~/Documents/Data/20210104_cos_videos/recorded_with_iphone.h5
```

Stalls `Ilastik` and `Fiji`. Try converting from original with `opencv` with `scripts/20210106_avi2avi_opencv.py`.

Didn't work, even to mp4. Created no output. Try converting to a sequence first with `ffmpeg`.

```{r, engine='bash'}
mkdir /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone_seq

ffmpeg \
  -i "/Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone.avi" \
  -f image2 "/Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone_seq/%05d.png"
```

```{r, engine='bash'}
ffmpeg -i \
  /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone.avi \
  -vcodec copy \
  -acodec copy \
  /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone.mp4  
```

```{r, engine='bash'}
ffmpeg \
  -i /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone.avi \
  -y /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone.mp4  
```
Creates 19MB video. Try converting back to AVI.

```{r, engine='bash'}
ffmpeg \
  -i /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone.mp4 \
  -y /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone_backconv.avi  
```

Creates a low-res video. Try with a different codec. 

```{r, engine='bash'}
ffmpeg \
  -i /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone.mp4 \
  -vcodec copy \
  -acodec copy \
  -y /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone_backconv.avi  
```

Doesn't play properly. Try to convert with python script anyway.

```{r, engine='bash'}
python3 code/scripts/20210106_avi2h5_fynn.py \
  ~/Documents/Data/20210104_cos_videos/recorded_with_iphone_backconv.avi \
  ~/Documents/Data/20210104_cos_videos/recorded_with_iphone_backconv.h5
```

Send to cluster to see if it works faster there.

```{r, engine='bash'}
ffmpeg \
  -i /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone.avi \
  -vcodec h264 \
  -y /Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone_h264.avi  
```

Extracted frames 900-1100 using `Fiji`, now convert to `h5` for `Ilastik`

```{r, engine='bash'}
python3 code/scripts/20210106_avi2h5_fynn.py \
  ~/Documents/Data/20210104_cos_videos/recorded_with_iphone_900-1100.avi \
  ~/Documents/Data/20210104_cos_videos/recorded_with_iphone_900-1100.h5
```

# Try with DeepLabCut

Trimmed video with `Fiji` (virtualstack is better because doesn't need to load it into memory.)
Frames 250-1345, saved here: `/Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone_trimmed.avi`

Opened video with `Fiji` Import -> AVI, selected frames 250 to 1345, then Export -> AVI using jpeg compressed and saved here:
`/Users/brettell/Documents/Data/20210104_cos_videos/recorded_with_iphone_trimmed_jpeg.avi`

Use that for DeepLabCut and Ilastik.

Now convert that to `h5` for `Ilastik`:

```{r, engine='bash'}
python3 code/scripts/20210106_avi2h5_fynn.py \
  ~/Documents/Data/20210104_cos_videos/recorded_with_iphone_trimmed_jpeg.avi \
  ~/Documents/Data/20210104_cos_videos/recorded_with_iphone_trimmed_jpeg.h5
```

Also convert original .mov to .avi

```{r, engine='bash'}
ffmpeg \
  -i ~/Documents/Data/20210104_cos_videos/raw_vid.mov \
  -vcodec h264 \
  -acodec copy \
  ~/Documents/Data/20210104_cos_videos/raw_vid.avi
```
Import `raw_vid.mov` directly to `Fiji`, then save as uncompressed .avi: 
`~/Documents/Data/20210104_cos_videos/raw_vid_fiji.avi` (note large file of 6.3GB)
Open that .avi, extract frames 900-1000, rotate, and save as:
`~/Documents/Data/20210104_cos_videos/raw_vid_fiji_short.avi`

*20210114*

New video:

`~/Documents/Data/20210104_cos_videos/20210108_OMR_Metal_halide_injured_Cab_MMStack_Default.ome.tif`

Converted to jpeg-compressed avi with `Fiji`:
`~/Documents/Data/20210104_cos_videos/20210108_OMR_Metal_halide_injured_Cab_MMStack_Default.ome_jpegcomp.avi`


